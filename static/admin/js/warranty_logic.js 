// Ð›Ð¾Ð³Ð¸ÐºÐ° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸ÐµÐ¹ Ð¸ Ð´Ð°Ñ‚Ð°Ð¼Ð¸
(function() {
    'use strict';
    
    function initWarrantyLogic() {
        console.log('ðŸ”§ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸...');
        
        // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿Ð°Ñ€Ñ‹ Ð¿Ð¾Ð»ÐµÐ¹: Ñ‡ÐµÐºÐ±Ð¾ÐºÑ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ â†’ Ð¿Ð¾Ð»Ðµ Ð´Ð°Ñ‚Ñ‹
        const warrantyPairs = [
            { warranty: 'display_warranty', date: 'display_date' },
            { warranty: 'case_warranty', date: 'case_date' },
            { warranty: 'cover_warranty', date: 'cover_date' },
            { warranty: 'general_360_warranty', date: 'general_360_date' },
            { warranty: 'side_warranty', date: 'side_date' },
            { warranty: 'lens_warranty', date: 'lens_date' }
        ];
        
        warrantyPairs.forEach(pair => {
            const warrantyCheckbox = document.querySelector(`input[name="${pair.warranty}"]`);
            const dateInput = document.querySelector(`input[name="${pair.date}"]`);
            
            if (warrantyCheckbox && dateInput) {
                console.log(`âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐ²ÑÐ·Ð¸: ${pair.warranty} â†’ ${pair.date}`);
                
                // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
                updateDateFieldState(warrantyCheckbox, dateInput);
                
                // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
                warrantyCheckbox.addEventListener('change', function() {
                    updateDateFieldState(this, dateInput);
                    
                    if (!this.checked) {
                        console.log(`âš ï¸ Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ "${pair.warranty}" Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. ÐŸÐ¾Ð»Ðµ Ð´Ð°Ñ‚Ñ‹ ÑÑ‚Ð°Ð½ÐµÑ‚ readonly Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸.`);
                    } else {
                        console.log(`âœ… Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ "${pair.warranty}" Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°. ÐŸÐ¾Ð»Ðµ Ð´Ð°Ñ‚Ñ‹ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾.`);
                    }
                });
            } else {
                console.warn(`âš ï¸ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ Ð¿Ð°Ñ€Ñ‹: ${pair.warranty} / ${pair.date}`);
            }
        });
        
        console.log('âœ… Ð›Ð¾Ð³Ð¸ÐºÐ° Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°');
    }
    
    function updateDateFieldState(warrantyCheckbox, dateInput) {
        if (!warrantyCheckbox || !dateInput) return;
        
        const isWarrantyActive = warrantyCheckbox.checked;
        
        if (isWarrantyActive) {
            // Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð° â†’ Ð¿Ð¾Ð»Ðµ Ð´Ð°Ñ‚Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
            dateInput.disabled = false;
            dateInput.style.opacity = '1';
            dateInput.style.cursor = 'text';
            dateInput.style.backgroundColor = '#ffffff';
            dateInput.style.borderColor = '#ced4da';
        } else {
            // Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð° â†’ Ð¿Ð¾Ð»Ðµ Ð´Ð°Ñ‚Ñ‹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾
            dateInput.disabled = true;
            dateInput.style.opacity = '0.6';
            dateInput.style.cursor = 'not-allowed';
            dateInput.style.backgroundColor = '#e9ecef';
            dateInput.style.borderColor = '#dee2e6';
        }
    }
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸
    function addTooltips() {
        const warrantyCheckboxes = document.querySelectorAll(
            'input[name$="_warranty"][type="checkbox"]'
        );
        
        warrantyCheckboxes.forEach(checkbox => {
            const label = checkbox.closest('.fieldBox, [class*="field"]')?.querySelector('label');
            if (label) {
                label.title = 'Ð¡Ð½Ð¸Ð¼Ð¸Ñ‚Ðµ Ð³Ð°Ð»Ð¾Ñ‡ÐºÑƒ, ÐºÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸ÑŽ. Ð”Ð°Ñ‚Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸.';
                label.style.cursor = 'help';
            }
        });
    }
    
    // ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸
    function addWarrantyWarning() {
        const warrantyCheckboxes = document.querySelectorAll(
            'input[name$="_warranty"][type="checkbox"]'
        );
        
        warrantyCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (!this.checked && !this.dataset.warningShown) {
                    // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·
                    const partName = this.name.replace('_warranty', '').replace('_', ' ');
                    console.log(`âš ï¸ Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: ÐŸÑ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð´Ð°Ñ‚Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð´Ð»Ñ "${partName}"`);
                    
                    // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ†Ð¸Ñ
                    const row = this.closest('.repair-detail-row, .row');
                    if (row) {
                        row.style.borderLeftColor = '#ffc107';
                        row.style.backgroundColor = '#fff3cd';
                        
                        setTimeout(() => {
                            row.style.borderLeftColor = '#007bff';
                            row.style.backgroundColor = '#f8f9fa';
                        }, 2000);
                    }
                    
                    this.dataset.warningShown = 'true';
                }
            });
        });
    }
    
    // ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ñ‚Ñ‹ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð½Ð° 1 Ð³Ð¾Ð´ Ð²Ð¿ÐµÑ€Ñ‘Ð´
    function addAutoDateFill() {
        const mainCheckboxes = document.querySelectorAll(
            'input[name="display"], input[name="case"], input[name="cover"], ' +
            'input[name="general_360"], input[name="side"], input[name="lens"]'
        );
        
        mainCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    const fieldName = this.name;
                    const warrantyCheckbox = document.querySelector(`input[name="${fieldName}_warranty"]`);
                    const dateInput = document.querySelector(`input[name="${fieldName}_date"]`);
                    
                    // Ð•ÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ‡ÐµÐºÐ±Ð¾ÐºÑ Ð¸ Ð´Ð°Ñ‚Ð° ÐµÑ‰Ñ‘ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°
                    if (warrantyCheckbox && dateInput && !dateInput.value) {
                        // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð³Ð°Ð»Ð¾Ñ‡ÐºÑƒ Ð½Ð° Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸ÑŽ
                        warrantyCheckbox.checked = true;
                        warrantyCheckbox.dispatchEvent(new Event('change'));
                        
                        // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð½Ð° 1 Ð³Ð¾Ð´ Ð²Ð¿ÐµÑ€Ñ‘Ð´
                        const today = new Date();
                        const oneYearLater = new Date(today.setFullYear(today.getFullYear() + 1));
                        const formattedDate = oneYearLater.toISOString().split('T')[0];
                        
                        dateInput.value = formattedDate;
                        dateInput.style.borderColor = '#28a745';
                        dateInput.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
                        
                        setTimeout(() => {
                            dateInput.style.borderColor = '#ced4da';
                            dateInput.style.boxShadow = 'none';
                        }, 1500);
                        
                        console.log(`âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð´Ð°Ñ‚Ð° Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ Ð½Ð° 1 Ð³Ð¾Ð´ Ð´Ð»Ñ "${fieldName}": ${formattedDate}`);
                    }
                }
            });
        });
    }
    
    // ÐŸÐ¾ÐºÐ°Ð· Ð¾ÑÑ‚Ð°Ð²ÑˆÐµÐ³Ð¾ÑÑ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸
    function showRemainingWarranty() {
        const dateInputs = document.querySelectorAll('input[name$="_date"][type="date"]:not([readonly])');
        
        dateInputs.forEach(input => {
            if (input.value) {
                const warrantyDate = new Date(input.value);
                const today = new Date();
                const diffTime = warrantyDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0 && diffDays <= 365) {
                    // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€
                    let indicator = input.nextElementSibling;
                    if (!indicator || !indicator.classList.contains('warranty-indicator')) {
                        indicator = document.createElement('small');
                        indicator.className = 'warranty-indicator';
                        indicator.style.cssText = `
                            display: block;
                            margin-top: 4px;
                            font-size: 11px;
                            font-weight: 500;
                        `;
                        input.insertAdjacentElement('afterend', indicator);
                    }
                    
                    // Ð¦Ð²ÐµÑ‚ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸Ñ…ÑÑ Ð´Ð½ÐµÐ¹
                    let color = '#28a745'; // Ð—ÐµÐ»Ñ‘Ð½Ñ‹Ð¹
                    if (diffDays <= 30) {
                        color = '#dc3545'; // ÐšÑ€Ð°ÑÐ½Ñ‹Ð¹
                    } else if (diffDays <= 90) {
                        color = '#ffc107'; // Ð–Ñ‘Ð»Ñ‚Ñ‹Ð¹
                    }
                    
                    indicator.style.color = color;
                    indicator.textContent = `ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ: ${diffDays} Ð´Ð½.`;
                }
            }
        });
    }
    
    // Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
    function init() {
        console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸ÐµÐ¹...');
        
        initWarrantyLogic();
        addTooltips();
        addWarrantyWarning();
        addAutoDateFill();
        showRemainingWarranty();
        
        console.log('âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸ÐµÐ¹ Ð³Ð¾Ñ‚Ð¾Ð²Ð°');
    }
    
    // Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        setTimeout(init, 150);
    }
    
    // ÐŸÐµÑ€ÐµÐ¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ… (Ð´Ð»Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°)
    const observer = new MutationObserver(function(mutations) {
        let shouldReinit = false;
        
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && (
                    node.querySelector?.('input[type="checkbox"]') ||
                    node.querySelector?.('input[type="date"]')
                )) {
                    shouldReinit = true;
                }
            });
        });
        
        if (shouldReinit) {
            setTimeout(init, 100);
        }
    });
    
    if (document.body) {
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
    
})();